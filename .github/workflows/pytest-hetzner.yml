name: pytest on Hetzner

on:
#  push:
#    branches: [ master ]
#  pull_request:
#    branches: [ master ]
  workflow_dispatch:



jobs:
  kitchen:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Hetzner server with cloud-init
        id: create
        run: |
          USERDATA=$(jq -Rs . < .github/cloud-init/user-data.yaml)
      
          echo "Creating serverâ€¦"
      
          SERVER=$(curl -s \
            -H "Authorization: Bearer ${{ secrets.HETZNER_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -X POST \
            -d "{
                 \"name\": \"salt-incus-formula-ci\",
                 \"server_type\": \"cx23\",
                 \"image\": \"ubuntu-22.04\",
                 \"ssh_keys\": [\"github-ci\"],
                  \"user_data\": $USERDATA
               }" \
            https://api.hetzner.cloud/v1/servers)
      
          echo "$SERVER" | jq .
      
          IP=$(echo "$SERVER" | jq -r '.server.public_net.ipv4.ip')
          ID=$(echo "$SERVER" | jq -r '.server.id')
      
          ACTION_ID=$(echo "$SERVER" | jq -r '.actions[0].id')
      
          echo "Server ID: $ID"
          echo "Public IP: $IP"
          echo "Action ID: $ACTION_ID"
      
          echo "id=$ID" >> $GITHUB_OUTPUT
          echo "ip=$IP" >> $GITHUB_OUTPUT
          echo "action_id=$ACTION_ID" >> $GITHUB_OUTPUT

      - name: Prepare SSH key
        run: |
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > id_ci
          chmod 600 id_ci

      - name: Wait for SSH
        run: |
          IP=${{ steps.create.outputs.ip }}
          for i in {1..300}; do
            if ssh -o StrictHostKeyChecking=no -i id_ci root@$IP "echo ok" 2>/dev/null; then
              echo "SSH available"
              exit 0
            fi
            echo "Waiting SSH..."
            sleep 5
          done
          exit 1

      - name: Wait for cloud-init to finish
        run: |
          IP=${{ steps.create.outputs.ip }}
          for i in {1..120}; do
            if ssh -o StrictHostKeyChecking=no -i id_ci root@$IP "test -f /var/lib/cloud/instance/boot-finished" 2>/dev/null; then
              echo "cloud-init finished"
              ssh -o StrictHostKeyChecking=no -i id_ci root@$IP "journalctl | grep cloud"
              exit 0
            fi
            echo "Waiting for cloud-init..."
            sleep 10
          done
          exit 1

      - name: Upload formula to VM
        run: |
          IP=${{ steps.create.outputs.ip }}
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          rsync -avz --exclude='.git' -e "ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa" \
            ./ root@$IP:/srv/formula/

      - name: Run Tests
        run: |
          IP=${{ steps.create.outputs.ip }}
          ssh -o StrictHostKeyChecking=no -i id_ci root@$IP "cd /srv/formula && bash .github/workflows/pytest-hetzner.sh"

      - name: Cleanup Hetzner VM
        if: always()
        run: |
          curl -s \
            -H "Authorization: Bearer ${{ secrets.HETZNER_API_TOKEN }}" \
            -X DELETE \
            https://api.hetzner.cloud/v1/servers/${{ steps.create.outputs.id }}
